'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.useLazyDisposableState = useLazyDisposableState;
const react_1 = require("react");
const useCachedResponsivePrecommitValue_1 = require("./useCachedResponsivePrecommitValue");
/**
 * useLazyDisposableState<T>
 * - Takes a mutable parent cache and a factory function
 * - Returns { state: T }
 *
 * This lazily loads the disposable item using useCachedResponsivePrecommitValue, then
 * (on commit) sets it in state. The item continues to be returned after
 * commit and is disposed when the hook unmounts.
 */
function useLazyDisposableState(parentCache) {
    var _a, _b;
    const itemCleanupPairRef = (0, react_1.useRef)(null);
    const preCommitItem = (0, useCachedResponsivePrecommitValue_1.useCachedResponsivePrecommitValue)(parentCache, (pair) => {
        var _a;
        (_a = itemCleanupPairRef.current) === null || _a === void 0 ? void 0 : _a[1]();
        itemCleanupPairRef.current = pair;
    });
    (0, react_1.useEffect)(() => {
        return () => {
            var _a;
            const cleanupFn = (_a = itemCleanupPairRef.current) === null || _a === void 0 ? void 0 : _a[1];
            // TODO confirm useEffect is called in order.
            if (cleanupFn == null) {
                throw new Error('cleanupFn unexpectedly null. This indicates a bug in react-disposable-state.');
            }
            return cleanupFn();
        };
    }, []);
    const returnedItem = (_a = preCommitItem === null || preCommitItem === void 0 ? void 0 : preCommitItem.state) !== null && _a !== void 0 ? _a : (_b = itemCleanupPairRef.current) === null || _b === void 0 ? void 0 : _b[0];
    if (returnedItem != null) {
        return { state: returnedItem };
    }
    // Safety: This can't happen. For renders before the initial commit, preCommitItem
    // is non-null. During the initial commit, we assign itemCleanupPairRef.current,
    // so during subsequent renders, itemCleanupPairRef.current is non-null.
    throw new Error('returnedItem was unexpectedly null. This indicates a bug in react-disposable-state.');
}
