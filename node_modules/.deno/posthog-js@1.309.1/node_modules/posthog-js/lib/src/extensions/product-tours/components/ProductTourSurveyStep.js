"use strict";
var __read = (this && this.__read) || function (o, n) {
    var m = typeof Symbol === "function" && o[Symbol.iterator];
    if (!m) return o;
    var i = m.call(o), r, ar = [], e;
    try {
        while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);
    }
    catch (error) { e = { error: error }; }
    finally {
        try {
            if (r && !r.done && (m = i["return"])) m.call(i);
        }
        finally { if (e) throw e.error; }
    }
    return ar;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.ProductTourSurveyStep = ProductTourSurveyStep;
var jsx_runtime_1 = require("preact/jsx-runtime");
var hooks_1 = require("preact/hooks");
var product_tours_utils_1 = require("../product-tours-utils");
var icons_1 = require("../../surveys/icons");
var icons_2 = require("../../surveys/icons");
var threeScaleEmojis = [icons_2.dissatisfiedEmoji, icons_2.neutralEmoji, icons_2.satisfiedEmoji];
var fiveScaleEmojis = [icons_2.veryDissatisfiedEmoji, icons_2.dissatisfiedEmoji, icons_2.neutralEmoji, icons_2.satisfiedEmoji, icons_2.verySatisfiedEmoji];
function getScaleNumbers(scale) {
    switch (scale) {
        case 5:
            return [1, 2, 3, 4, 5];
        case 10:
            return [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
        default:
            return [1, 2, 3, 4, 5];
    }
}
function OpenTextInput(_a) {
    var value = _a.value, onChange = _a.onChange, onSubmit = _a.onSubmit;
    var inputRef = (0, hooks_1.useRef)(null);
    (0, hooks_1.useEffect)(function () {
        setTimeout(function () { var _a; return (_a = inputRef.current) === null || _a === void 0 ? void 0 : _a.focus(); }, 100);
    }, []);
    var handleKeyDown = function (e) {
        if (e.key === 'Enter' && e.metaKey) {
            e.preventDefault();
            onSubmit();
        }
    };
    return ((0, jsx_runtime_1.jsx)("textarea", { ref: inputRef, class: "ph-tour-survey-textarea", rows: 3, placeholder: "Your feedback (optional)...", value: value, onInput: function (e) { return onChange(e.target.value); }, onKeyDown: handleKeyDown }));
}
function RatingInput(_a) {
    var survey = _a.survey, onSubmit = _a.onSubmit;
    var _b = __read((0, hooks_1.useState)(null), 2), selectedRating = _b[0], setSelectedRating = _b[1];
    var display = survey.display || 'emoji';
    var scale = survey.scale || 5;
    var handleSelect = function (rating) {
        setSelectedRating(rating);
        // Auto-submit on selection for ratings
        onSubmit(rating);
    };
    if (display === 'emoji') {
        var emojis = scale === 3 ? threeScaleEmojis : fiveScaleEmojis;
        return ((0, jsx_runtime_1.jsxs)("div", { class: "ph-tour-survey-rating-container", children: [(0, jsx_runtime_1.jsx)("div", { class: "ph-tour-survey-rating-emoji", children: emojis.map(function (emoji, idx) {
                        var rating = idx + 1;
                        var isActive = selectedRating === rating;
                        return ((0, jsx_runtime_1.jsx)("button", { type: "button", class: "ph-tour-survey-emoji-button ".concat(isActive ? 'ph-tour-survey-emoji-button--active' : ''), onClick: function () { return handleSelect(rating); }, "aria-label": "Rate ".concat(rating), children: emoji }, idx));
                    }) }), (survey.lowerBoundLabel || survey.upperBoundLabel) && ((0, jsx_runtime_1.jsxs)("div", { class: "ph-tour-survey-rating-labels", children: [(0, jsx_runtime_1.jsx)("span", { children: survey.lowerBoundLabel }), (0, jsx_runtime_1.jsx)("span", { children: survey.upperBoundLabel })] }))] }));
    }
    // Number display
    var numbers = getScaleNumbers(scale);
    return ((0, jsx_runtime_1.jsxs)("div", { class: "ph-tour-survey-rating-container", children: [(0, jsx_runtime_1.jsx)("div", { class: "ph-tour-survey-rating-numbers", style: { gridTemplateColumns: "repeat(".concat(numbers.length, ", minmax(0, 1fr))") }, children: numbers.map(function (num) {
                    var isActive = selectedRating === num;
                    return ((0, jsx_runtime_1.jsx)("button", { type: "button", class: "ph-tour-survey-number-button ".concat(isActive ? 'ph-tour-survey-number-button--active' : ''), onClick: function () { return handleSelect(num); }, "aria-label": "Rate ".concat(num), children: num }, num));
                }) }), (survey.lowerBoundLabel || survey.upperBoundLabel) && ((0, jsx_runtime_1.jsxs)("div", { class: "ph-tour-survey-rating-labels", children: [(0, jsx_runtime_1.jsx)("span", { children: survey.lowerBoundLabel }), (0, jsx_runtime_1.jsx)("span", { children: survey.upperBoundLabel })] }))] }));
}
function ProductTourSurveyStep(_a) {
    var tour = _a.tour, step = _a.step, stepIndex = _a.stepIndex, totalSteps = _a.totalSteps, onSubmit = _a.onSubmit, onPrevious = _a.onPrevious, onDismiss = _a.onDismiss;
    var _b = __read((0, hooks_1.useState)(''), 2), textValue = _b[0], setTextValue = _b[1];
    var appearance = (0, product_tours_utils_1.mergeAppearance)(tour.appearance);
    var survey = step.survey;
    var isFirstStep = stepIndex === 0;
    var isOpenText = (survey === null || survey === void 0 ? void 0 : survey.type) === 'open';
    var handleTextSubmit = function () {
        onSubmit(textValue.trim() || null);
    };
    if (!survey) {
        return (0, jsx_runtime_1.jsx)("div", {});
    }
    var handleOverlayClick = function (e) {
        e.stopPropagation();
        onDismiss('user_clicked_outside');
    };
    var handleCardClick = function (e) {
        e.stopPropagation();
    };
    var containerStyle = {
        '--ph-tour-background-color': appearance.backgroundColor,
        '--ph-tour-text-color': appearance.textColor,
        '--ph-tour-button-color': appearance.buttonColor,
        '--ph-tour-button-text-color': appearance.buttonTextColor,
        '--ph-tour-border-radius': "".concat(appearance.borderRadius, "px"),
        '--ph-tour-border-color': appearance.borderColor,
    };
    return ((0, jsx_runtime_1.jsxs)("div", { class: "ph-tour-container", style: containerStyle, children: [(0, jsx_runtime_1.jsx)("div", { class: "ph-tour-click-overlay", onClick: handleOverlayClick }), (0, jsx_runtime_1.jsx)("div", { class: "ph-tour-modal-overlay" }), (0, jsx_runtime_1.jsxs)("div", { class: "ph-tour-tooltip ph-tour-tooltip--modal ph-tour-survey-step", onClick: handleCardClick, children: [(0, jsx_runtime_1.jsx)("button", { class: "ph-tour-dismiss", onClick: function () { return onDismiss('user_clicked_skip'); }, "aria-label": "Close survey", children: icons_1.cancelSVG }), (0, jsx_runtime_1.jsx)("div", { class: "ph-tour-survey-question", children: survey.questionText }), isOpenText ? ((0, jsx_runtime_1.jsx)(OpenTextInput, { value: textValue, onChange: setTextValue, onSubmit: handleTextSubmit })) : ((0, jsx_runtime_1.jsx)(RatingInput, { survey: survey, onSubmit: onSubmit })), (0, jsx_runtime_1.jsxs)("div", { class: "ph-tour-footer", children: [(0, jsx_runtime_1.jsxs)("span", { class: "ph-tour-progress", children: [stepIndex + 1, " of ", totalSteps] }), (0, jsx_runtime_1.jsxs)("div", { class: "ph-tour-buttons", children: [!isFirstStep && ((0, jsx_runtime_1.jsx)("button", { class: "ph-tour-button ph-tour-button--secondary", onClick: onPrevious, children: "Back" })), isOpenText && ((0, jsx_runtime_1.jsx)("button", { class: "ph-tour-button ph-tour-button--primary", onClick: handleTextSubmit, children: "Submit" }))] })] }), !appearance.whiteLabel && ((0, jsx_runtime_1.jsxs)("a", { href: "https://posthog.com/product-tours", target: "_blank", rel: "noopener noreferrer", class: "ph-tour-branding", children: ["Survey by ", icons_1.IconPosthogLogo] }))] })] }));
}
//# sourceMappingURL=ProductTourSurveyStep.js.map