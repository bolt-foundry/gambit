"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.useReadAndSubscribe = useReadAndSubscribe;
exports.useSubscribeToMultiple = useSubscribeToMultiple;
const react_1 = require("react");
const cache_1 = require("../core/cache");
const FragmentReference_1 = require("../core/FragmentReference");
const PromiseWrapper_1 = require("../core/PromiseWrapper");
const read_1 = require("../core/read");
const IsographEnvironmentProvider_1 = require("./IsographEnvironmentProvider");
const useRerenderOnChange_1 = require("./useRerenderOnChange");
/**
 * Read the data from a fragment reference and subscribe to updates.
 */
function useReadAndSubscribe(fragmentReference, networkRequestOptions, readerAst) {
    const environment = (0, IsographEnvironmentProvider_1.useIsographEnvironment)();
    const [readOutDataAndRecords, setReadOutDataAndRecords] = (0, react_1.useState)(() => (0, read_1.readButDoNotEvaluate)(environment, fragmentReference, networkRequestOptions));
    (0, useRerenderOnChange_1.useRerenderOnChange)(readOutDataAndRecords, fragmentReference, setReadOutDataAndRecords, readerAst);
    return readOutDataAndRecords.item;
}
function useSubscribeToMultiple(items) {
    const environment = (0, IsographEnvironmentProvider_1.useIsographEnvironment)();
    (0, react_1.useEffect)(() => {
        const cleanupFns = items.map(({ records, callback, fragmentReference, readerAst }) => {
            return (0, cache_1.subscribe)(environment, records, fragmentReference, callback, readerAst);
        });
        return () => {
            cleanupFns.forEach((loader) => {
                loader();
            });
        };
    }, 
    // By analogy to useReadAndSubscribe, we can have an empty dependency array?
    // Maybe callback has to be depended on. I don't know!
    // TODO find out
    [
        items
            .map(({ fragmentReference }) => {
            const readerWithRefetchQueries = (0, PromiseWrapper_1.readPromise)(fragmentReference.readerWithRefetchQueries);
            (0, FragmentReference_1.stableIdForFragmentReference)(fragmentReference, readerWithRefetchQueries.readerArtifact.fieldName);
        })
            .join('.'),
    ]);
}
