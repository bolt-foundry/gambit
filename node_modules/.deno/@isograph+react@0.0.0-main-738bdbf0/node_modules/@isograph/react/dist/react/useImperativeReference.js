"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.useImperativeReference = useImperativeReference;
const react_disposable_state_1 = require("@isograph/react-disposable-state");
const IsographEnvironment_1 = require("../core/IsographEnvironment");
const makeNetworkRequest_1 = require("../core/makeNetworkRequest");
const PromiseWrapper_1 = require("../core/PromiseWrapper");
const IsographEnvironmentProvider_1 = require("./IsographEnvironmentProvider");
function useImperativeReference(entrypoint) {
    const { state, setState } = (0, react_disposable_state_1.useUpdatableDisposableState)();
    const environment = (0, IsographEnvironmentProvider_1.useIsographEnvironment)();
    return {
        fragmentReference: state !== react_disposable_state_1.UNASSIGNED_STATE ? state : null,
        loadFragmentReference: (variables, fetchOptions) => {
            const readerWithRefetchQueries = entrypoint.readerWithRefetchQueries.kind ===
                'ReaderWithRefetchQueriesLoader'
                ? (0, PromiseWrapper_1.wrapPromise)(entrypoint.readerWithRefetchQueries.loader())
                : (0, PromiseWrapper_1.wrapResolvedValue)(entrypoint.readerWithRefetchQueries);
            const [networkRequest, disposeNetworkRequest] = (0, makeNetworkRequest_1.maybeMakeNetworkRequest)(environment, entrypoint, variables, readerWithRefetchQueries, fetchOptions !== null && fetchOptions !== void 0 ? fetchOptions : null);
            setState([
                {
                    kind: 'FragmentReference',
                    readerWithRefetchQueries,
                    root: { __link: IsographEnvironment_1.ROOT_ID, __typename: entrypoint.concreteType },
                    variables,
                    networkRequest,
                },
                () => {
                    disposeNetworkRequest();
                },
            ]);
        },
    };
}
