"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.DEFAULT_SHOULD_FETCH_VALUE = void 0;
exports.check = check;
const cache_1 = require("./cache");
const IsographEnvironment_1 = require("./IsographEnvironment");
const logging_1 = require("./logging");
exports.DEFAULT_SHOULD_FETCH_VALUE = 'IfNecessary';
function check(environment, normalizationAst, variables, root) {
    var _a, _b;
    var _c, _d, _e;
    const recordsById = ((_a = (_c = environment.store)[_d = root.__typename]) !== null && _a !== void 0 ? _a : (_c[_d] = {}));
    const newStoreRecord = ((_b = recordsById[_e = root.__link]) !== null && _b !== void 0 ? _b : (recordsById[_e] = {}));
    const checkResult = checkFromRecord(environment, normalizationAst, variables, newStoreRecord, root);
    (0, logging_1.logMessage)(environment, () => ({
        kind: 'EnvironmentCheck',
        result: checkResult,
    }));
    return checkResult;
}
function checkFromRecord(environment, normalizationAst, variables, record, recordLink) {
    var _a, _b;
    normalizationAstLoop: for (const normalizationAstNode of normalizationAst) {
        switch (normalizationAstNode.kind) {
            case 'Scalar': {
                const parentRecordKey = (0, cache_1.getParentRecordKey)(normalizationAstNode, variables);
                const scalarValue = record[parentRecordKey];
                // null means the value is known to be missing, so it must
                // be exactly undefined
                if (scalarValue === undefined) {
                    return {
                        kind: 'MissingData',
                        record: recordLink,
                    };
                }
                continue normalizationAstLoop;
            }
            case 'Linked': {
                const parentRecordKey = (0, cache_1.getParentRecordKey)(normalizationAstNode, variables);
                const linkedValue = record[parentRecordKey];
                if (linkedValue === undefined) {
                    return {
                        kind: 'MissingData',
                        record: recordLink,
                    };
                }
                else if (linkedValue === null) {
                    continue;
                }
                else if (Array.isArray(linkedValue)) {
                    arrayItemsLoop: for (const item of linkedValue) {
                        const link = (0, IsographEnvironment_1.getLink)(item);
                        if (link === null) {
                            throw new Error('Unexpected non-link in the Isograph store. ' +
                                'This is indicative of a bug in Isograph.');
                        }
                        const linkedRecord = (_a = environment.store[link.__typename]) === null || _a === void 0 ? void 0 : _a[link.__link];
                        if (linkedRecord === undefined) {
                            return {
                                kind: 'MissingData',
                                record: link,
                            };
                        }
                        else if (linkedRecord === null) {
                            continue arrayItemsLoop;
                        }
                        else {
                            // TODO in __DEV__ assert linkedRecord is an object
                            const result = checkFromRecord(environment, normalizationAstNode.selections, variables, linkedRecord, link);
                            if (result.kind === 'MissingData') {
                                return result;
                            }
                        }
                    }
                }
                else {
                    const link = (0, IsographEnvironment_1.getLink)(linkedValue);
                    if (link === null) {
                        throw new Error('Unexpected non-link in the Isograph store. ' +
                            'This is indicative of a bug in Isograph.');
                    }
                    const linkedRecord = (_b = environment.store[link.__typename]) === null || _b === void 0 ? void 0 : _b[link.__link];
                    if (linkedRecord === undefined) {
                        return {
                            kind: 'MissingData',
                            record: link,
                        };
                    }
                    else if (linkedRecord === null) {
                        continue normalizationAstLoop;
                    }
                    else {
                        // TODO in __DEV__ assert linkedRecord is an object
                        const result = checkFromRecord(environment, normalizationAstNode.selections, variables, linkedRecord, link);
                        if (result.kind === 'MissingData') {
                            return result;
                        }
                    }
                }
                continue normalizationAstLoop;
            }
            case 'InlineFragment': {
                const existingRecordTypename = record['__typename'];
                if (existingRecordTypename == null) {
                    return {
                        kind: 'MissingData',
                        record: recordLink,
                    };
                }
                if (existingRecordTypename === normalizationAstNode.type) {
                    const result = checkFromRecord(environment, normalizationAstNode.selections, variables, record, recordLink);
                    if (result.kind === 'MissingData') {
                        return result;
                    }
                }
                continue normalizationAstLoop;
            }
            default: {
                let _ = normalizationAstNode;
                _;
                throw new Error('Unexpected case. This is indicative of a bug in Isograph.');
            }
        }
    }
    return {
        kind: 'EnoughData',
    };
}
