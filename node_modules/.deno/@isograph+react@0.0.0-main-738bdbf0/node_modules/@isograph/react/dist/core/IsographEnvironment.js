"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ROOT_ID = void 0;
exports.createIsographEnvironment = createIsographEnvironment;
exports.createIsographStore = createIsographStore;
exports.assertLink = assertLink;
exports.getLink = getLink;
exports.getOrLoadIsographArtifact = getOrLoadIsographArtifact;
const PromiseWrapper_1 = require("./PromiseWrapper");
exports.ROOT_ID = '__ROOT';
const DEFAULT_GC_BUFFER_SIZE = 10;
function createIsographEnvironment(store, networkFunction, missingFieldHandler, logFunction) {
    logFunction === null || logFunction === void 0 ? void 0 : logFunction({
        kind: 'EnvironmentCreated',
    });
    return {
        store,
        networkFunction,
        missingFieldHandler: missingFieldHandler !== null && missingFieldHandler !== void 0 ? missingFieldHandler : null,
        componentCache: {},
        eagerReaderCache: {},
        subscriptions: new Set(),
        fragmentCache: {},
        entrypointArtifactCache: new Map(),
        retainedQueries: new Set(),
        gcBuffer: [],
        gcBufferSize: DEFAULT_GC_BUFFER_SIZE,
        loggers: logFunction != null ? new Set([{ log: logFunction }]) : new Set(),
    };
}
function createIsographStore() {
    return {
        Query: {
            [exports.ROOT_ID]: {},
        },
    };
}
function assertLink(link) {
    if (Array.isArray(link)) {
        throw new Error('Unexpected array');
    }
    if (link == null) {
        return link;
    }
    if (typeof link === 'object') {
        return link;
    }
    throw new Error('Invalid link');
}
function getLink(maybeLink) {
    if (maybeLink != null &&
        typeof maybeLink === 'object' &&
        '__link' in maybeLink &&
        maybeLink.__link != null &&
        '__typename' in maybeLink &&
        maybeLink.__typename != null) {
        return maybeLink;
    }
    return null;
}
function getOrLoadIsographArtifact(environment, key, loader) {
    const value = environment.entrypointArtifactCache.get(key);
    if (value != null) {
        return value;
    }
    const wrapped = (0, PromiseWrapper_1.wrapPromise)(loader());
    environment.entrypointArtifactCache.set(key, wrapped);
    return wrapped;
}
