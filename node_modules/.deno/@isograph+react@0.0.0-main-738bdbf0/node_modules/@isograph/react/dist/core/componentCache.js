"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getOrCreateCachedComponent = getOrCreateCachedComponent;
const useReadAndSubscribe_1 = require("../react/useReadAndSubscribe");
const FragmentReference_1 = require("./FragmentReference");
const logging_1 = require("./logging");
const PromiseWrapper_1 = require("./PromiseWrapper");
const startUpdate_1 = require("./startUpdate");
function getOrCreateCachedComponent(environment, componentName, fragmentReference, networkRequestOptions) {
    var _a;
    var _b, _c;
    // We create startUpdate outside of component to make it stable
    const startUpdate = (0, startUpdate_1.createStartUpdate)(environment, fragmentReference, networkRequestOptions);
    return ((_a = (_b = environment.componentCache)[_c = (0, FragmentReference_1.stableIdForFragmentReference)(fragmentReference, componentName)]) !== null && _a !== void 0 ? _a : (_b[_c] = (() => {
        function Component(additionalRuntimeProps) {
            const readerWithRefetchQueries = (0, PromiseWrapper_1.readPromise)(fragmentReference.readerWithRefetchQueries);
            const data = (0, useReadAndSubscribe_1.useReadAndSubscribe)(fragmentReference, networkRequestOptions, readerWithRefetchQueries.readerArtifact.readerAst);
            (0, logging_1.logMessage)(environment, () => ({
                kind: 'ComponentRerendered',
                componentName,
                rootLink: fragmentReference.root,
            }));
            return readerWithRefetchQueries.readerArtifact.resolver({
                data,
                parameters: fragmentReference.variables,
                startUpdate: readerWithRefetchQueries.readerArtifact.hasUpdatable
                    ? startUpdate
                    : undefined,
            }, additionalRuntimeProps);
        }
        const idString = `(type: ${fragmentReference.root.__typename}, id: ${fragmentReference.root.__link})`;
        Component.displayName = `${componentName} ${idString} @component`;
        return Component;
    })()));
}
