name: E2E Manual

on:
  workflow_dispatch: {}

jobs:
  e2e:
    name: Gambit E2E
    runs-on: blacksmith-4vcpu-ubuntu-2404
    timeout-minutes: 30
    permissions:
      contents: read
      id-token: write
    env:
      NIX_DEV_PROFILE: ${{ github.workspace }}/.nix-profiles/ci
      DENO_DIR: /home/runner/.cache/deno
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/deno-ci-setup
        with:
          nix_dev_profile: ${{ env.NIX_DEV_PROFILE }}
          deno_dir: ${{ env.DENO_DIR }}

      - name: Prepare local gambit-core import map
        run: |
          nix develop --profile "$NIX_DEV_PROFILE" --command deno eval --ext=ts -q '
            import { parse } from "jsr:@std/jsonc@1";
            const exists = async (path) => {
              try {
                await Deno.stat(path);
                return true;
              } catch (err) {
                if (err instanceof Deno.errors.NotFound) {
                  return false;
                }
                throw err;
              }
            };
            const findPath = async (candidates, label) => {
              for (const candidate of candidates) {
                if (await exists(candidate)) {
                  return candidate;
                }
              }
              throw new Error(
                `Unable to find ${label} at: ${candidates.join(", ")}`,
              );
            };
            const gambitPath = await findPath(
              [
                "deno.jsonc",
                "deno.json",
                "packages/gambit/deno.jsonc",
                "packages/gambit/deno.json",
              ],
              "gambit deno.json(c)",
            );
            const corePath = await findPath(
              ["packages/gambit-core/deno.json"],
              "gambit-core deno.json",
            );
            const gambit = parse(await Deno.readTextFile(gambitPath));
            const core = parse(await Deno.readTextFile(corePath));
            const exportsMap = core.exports ?? {};
            const localImports = {};
            for (const [key, value] of Object.entries(exportsMap)) {
              if (typeof value !== "string") continue;
              const suffix = key === "." ? "" : key.startsWith("./")
                ? key.slice(1)
                : key;
              const spec = `@molt-foundry/gambit-core${suffix}`;
              const rel = value.startsWith("./") ? value.slice(2) : value;
              localImports[spec] = `./packages/gambit-core/${rel}`;
            }
            gambit.imports = { ...(gambit.imports ?? {}), ...localImports };
            await Deno.writeTextFile(
              "deno.ci.json",
              JSON.stringify(gambit, null, 2) + "\n",
            );
          '

      - name: Guard bfmono imports
        run: |
          nix develop --profile "$NIX_DEV_PROFILE" --command deno run -A --config deno.ci.json scripts/guard-bfmono-imports.ts

      - name: Install CLI deps (entrypoint only)
        run: |
          nix develop --profile "$NIX_DEV_PROFILE" --command bash -euo pipefail -c '
            rm -f deno.entrypoint.lock
            deno install --entrypoint --config deno.ci.json --lock=deno.entrypoint.lock --frozen=false --no-prompt src/cli.ts
          '

      - name: Run e2e tests
        run: |
          nix develop --profile "$NIX_DEV_PROFILE" --command deno test --config deno.ci.json -A simulator-ui/__tests__/e2e/*.e2e.ts

      - uses: ./.github/actions/deno-ci-cleanup
        if: always()
