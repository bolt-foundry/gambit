name: ci-gambit-core

on:
  push:
    branches: ["main", "master"]
    paths:
      - packages/gambit-core/**
      - .github/workflows/ci-gambit-core.yml
  pull_request:
    branches: ["*"]
    paths:
      - packages/gambit-core/**
      - .github/workflows/ci-gambit-core.yml

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v13

      - name: Register Deno problem matcher
        run: echo '::add-matcher::.github/deno-problem-matcher.json'

      - name: Debug toolchain
        run: |
          nix develop "$GITHUB_WORKSPACE" --command bash -euo pipefail <<'EOF'
          echo "deno --version:"
          deno --version
          deno eval -q 'console.log("deno version json", JSON.stringify(Deno.version))'
          echo "node --version:"
          node --version || true
          node -p 'process.versions' || true
          echo "npm --version:"
          npm --version || true
          echo "DENO_DIR: ${DENO_DIR:-<unset>}"
          echo "deno.json (gambit-core):"
          cat packages/gambit-core/deno.json
          if [ -f deno.json ]; then
            echo "deno.json (root):"
            cat deno.json
          elif [ -f packages/gambit/deno.json ]; then
            echo "deno.json (packages/gambit):"
            cat packages/gambit/deno.json
          fi
          deno eval -q '
            const core = JSON.parse(await Deno.readTextFile("packages/gambit-core/deno.json"));
            console.log("core types", core.compilerOptions?.types ?? null);
            console.log("core @types/node", core.imports?.["@types/node"] ?? null);
          '
          EOF

      - name: Guard bfmono imports
        run: nix develop "$GITHUB_WORKSPACE" --command deno run -A scripts/guard-bfmono-imports.ts

      - name: Lint
        run: nix develop "$GITHUB_WORKSPACE" --command deno lint
        working-directory: packages/gambit-core

      - name: Format check
        run: nix develop "$GITHUB_WORKSPACE" --command deno fmt --check
        working-directory: packages/gambit-core

      - name: Type check
        run: nix develop "$GITHUB_WORKSPACE" --command deno check --all mod.ts
        working-directory: packages/gambit-core

      - name: Build npm package
        run: nix develop "$GITHUB_WORKSPACE" --command deno task build_npm
        working-directory: packages/gambit-core

      - name: Test
        run: nix develop "$GITHUB_WORKSPACE" --command deno task test
        working-directory: packages/gambit-core
